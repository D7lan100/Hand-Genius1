{% extends "admin/base_admin.html" %}
{% block title %}Gesti√≥n de Pedidos{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üì¶ Gesti√≥n de Pedidos</h2>

  {% if pedidos %}
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark text-center">
      <tr>
        <th>ID</th>
        <th>Usuario</th>
        <th>Fecha</th>
        <th>M√©todo</th>
        <th>Estado</th>
        <th>Comprobante</th>
        <th>Env√≠o</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for p in pedidos %}
      <tr class="text-center">
        <td>{{ p.id_pedido }}</td>
        <td>{{ p.usuario }}</td>
        <td>{{ p.fecha_pedido.strftime('%d/%m/%Y') if p.fecha_pedido else '' }}</td>
        <td>{{ p.metodo_pago or 'No especificado' }}</td>
        <td>
          <span class="badge 
            {% if p.estado == 'pendiente' %}bg-warning text-dark
            {% elif p.estado == 'en_revision' %}bg-info
            {% elif p.estado == 'pagado' %}bg-success
            {% elif p.estado == 'enviado' %}bg-primary
            {% elif p.estado == 'entregado' %}bg-dark
            {% else %}bg-secondary{% endif %}">
            {{ p.estado | capitalize }}
          </span>
        </td>
        <td>
          {% if p.comprobante_pago %}
            <a href="{{ url_for('static', filename='comprobantes/' ~ p.comprobante_pago) }}" 
               target="_blank" class="btn btn-sm btn-outline-primary">Ver</a>
          {% else %}
            <span class="text-muted">N/A</span>
          {% endif %}
        </td>
        <td>
          {% if p.empresa_transportadora %}
            {{ p.empresa_transportadora }}<br>
            <small>{{ p.fecha_envio.strftime('%d/%m/%Y') if p.fecha_envio else '' }}</small>
          {% else %}
            <span class="text-muted">No enviado</span>
          {% endif %}
        </td>
        <td>
          <form action="{{ url_for('admin_bp.actualizar_pedido', id_pedido=p.id_pedido) }}" method="POST" class="d-flex flex-column gap-1">
            <select name="estado" class="form-select form-select-sm mb-1">
              <option value="pendiente" {% if p.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
              <option value="en_revision" {% if p.estado == 'en_revision' %}selected{% endif %}>En Revisi√≥n</option>
              <option value="pagado" {% if p.estado == 'pagado' %}selected{% endif %}>Pagado</option>
              <option value="enviado" {% if p.estado == 'enviado' %}selected{% endif %}>Enviado</option>
              <option value="entregado" {% if p.estado == 'entregado' %}selected{% endif %}>Entregado</option>
            </select>

            <input type="text" name="empresa_transportadora" class="form-control form-control-sm mb-1"
                   placeholder="Transportadora (si aplica)" value="{{ p.empresa_transportadora or '' }}">

            <input type="date" name="fecha_envio" class="form-control form-control-sm mb-1"
                   value="{{ p.fecha_envio.strftime('%Y-%m-%d') if p.fecha_envio else '' }}">

            <button type="submit" class="btn btn-sm btn-success">Actualizar</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="alert alert-info text-center">
    No hay pedidos registrados.
  </div>
  {% endif %}
</div>
{% endblock %}
